## 目标

- 对 `huobi`（货币基金）资产按日计算收益，采用复利（当日收益计入本金）。
- 在每天凌晨 `00:01` 自动更新资产的 `amount` 并新增一条 `AssetChange` 记录（before/after/diff/notes）。
- 详情页收益概览与资产总值随后台更新自动反映，无需前端自算兜底。

## 现状梳理

- 数据模型：`Asset` 已含 `annualRate/startDate`（prisma/schema.prisma:36-37），`AssetChange` 模型完整（prisma/schema.prisma:81-94）。
- 变更接口：已有 `GET/POST /api/assets/[id]/changes`（app/api/assets/[id]/changes/route.ts）与 `PUT /api/assets/[id]` 自动生成变更（app/api/assets/[id]/route.ts:24-31）。
- 详情页：已展示货币基金识别、收益概览与编辑资产（app/assets/[id]/page.tsx）。

## 后端作业接口

- 新增作业路由：`app/api/jobs/money-fund-daily/route.ts`
- 逻辑：
  - 查询所有货币基金资产（`type.code in ['huobi','money_fund']` 或 `type.label` 包含“货币基金”），且 `annualRate` 与 `startDate` 有效。
  - 以当天（Asia/Shanghai）为基准，计算需要补算的天数：`days = max(1, today - lastValuationDate)`。
  - 对每个待处理日：
    - `dailyInterest = amount * annualRate / 365`
    - `after = amount + dailyInterest`
    - 调用 `prisma.asset.update` 更新 `amount=after`，`valuationDate = 当天日期`。
    - 同步 `prisma.assetChange.create`，记录 `beforeAmount/afterAmount/diff`，`notes = '自动收益(日复利)'`。
  - 幂等保护：同一天如已存在 `assetChange`（`assetId`+当天日期范围）且 `notes` 为自动收益，则跳过。
- 安全：
  - 作业路由采用轻量鉴权：校验请求头 `X-Job-Token` 与 `process.env.JOB_TOKEN` 相等；否则 401。

## 调度方案（Render）

- 在 Render 上创建 Cron Job，配置：
  - URL：`https://<your-host>/api/jobs/money-fund-daily`
  - Method：`POST`
  - Header：`X-Job-Token: <JOB_TOKEN>`（同时在服务中设置环境变量 `JOB_TOKEN`）。
  - 计划：`每天 00:01 Asia/Shanghai`（如 Render 以 UTC 调度，需折算为 `UTC 16:01`）。

## 前端适配

- 详情页无需再进行“动态日收益自算并入金额”，保持展示后端返回的 `asset.amount` 与收益概览（基于已保存的 `annualRate/startDate` 计算展示）。
- 当天页面打开时如希望不刷新即可感知：可在进入页面时比较 `valuationDate` 与当天，若一致则直接显示复利后的金额；否则提示“将于 00:01 自动更新”。（可选）

## 验证与回滚

- 本地验证：创建一个 `huobi` 资产，设定 `annualRate=0.03`，`startDate=过去日期`，手动调用作业接口（携带 `X-Job-Token`）观察：
  - `Asset.amount` 按公式增长；`AssetChange` 有新增记录。
  - 详情页收益概览与资产总值与数据库一致。
- 幂等测试：同一日期重复触发不重复记账。
- 回滚：如需撤销当日自动收益，可删除当日 `AssetChange` 并将 `Asset.amount` 回退到 `beforeAmount`。

## 边界与设定

- 年化利率为小数（如 `0.03` 表示 3%）。
- 若 `startDate` 晚于当前日，则跳过；若历史有停机，按差异天数补算多日复利。
- 货币基金不参与持仓管理；仅变更 `Asset.amount` 与记账。

若您确认该方案，我将开始实现：新增作业路由、编写复利计算与幂等保护、接入轻量鉴权，并给出 Render Cron 配置示例与本地验证脚本。