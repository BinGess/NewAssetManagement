## 目标

* 股票资产详情页：在用户已维护持仓后，动态调用公共行情接口，实时展示当前价格与总值。

* 每日 18:00（Asia/Shanghai）基于当日收盘价，自动更新该股票资产的总价值，并新增资产变更记录。

## 数据与前置约定

* 复用现有持仓结构：`AssetHolding{name, price, quantity}`。在现有的基础上，再添加一个字段，即股票代码code

* 将持仓的 `code和name `作为股票代码/标识（如 `600519`、`AAPL`）。若后续需要更精确的映射（交易所前缀等），可扩展为 `symbol` 字段，但本次先以 `code` 作为符号来源。

## 后端实现

* 行情查询接口：`GET /api/quotes`

  * 参数：`symbols`（逗号分隔）。

  * 返回：每个符号的 `symbol`、`price`（实时/最新成交）、`prevClose`、`ts`。

  * 实现：服务端通过 `fetch` 调用公共行情源（可配置，优先选用无需密钥的来源；如需要密钥则用 `process.env.QUOTES_TOKEN`）。

  * 需要调研公共行情源，这里需要了解市面上，有什么免费，能查询A股，港股和美股的股票价格变化，公共数据接口

  * 容错：单个符号失败不影响整体，返回 `null` 价格并在前端标注。

* 每日收盘作业：`POST /api/jobs/stock-close-daily`

  * 鉴权：支持 `X-Job-Token` 或管理员登录（`requireAuth`），与货币基金相同模式。

  * 筛选：`type.code === 'stock'` 的资产；读取其持仓列表。

  * 获取当日收盘价：调用行情查询接口，取 `prevClose`（或收盘价字段）。

  * 计算：总值 = Σ(`prevClose * quantity`)；保留两位小数。

  * 更新：`Asset.amount = 总值`、`valuationDate = 当日`，并写入 `AssetChange`（`notes='自动收盘价更新'`）。

  * 幂等：当日存在相同备注的变更则跳过（避免重复）。

  * 时区：使用 Asia/Shanghai 的当日边界计算与判定。

## 前端改造（资产详情页 - stock）

* 新增“实时价格与总值”卡片：

  * 页面加载时将持仓 `name` 组装为符号列表，调用 `GET /api/quotes`。

  * 展示每个持仓的实时价与小计、以及页面顶部的“当前总值”（按实时价计算）。

  * 支持手动刷新按钮；可选每 30–60 秒自动刷新（节流）。

* 在“资产变更详情”标题附近显示当日 18:00 更新状态：

  * 若当日存在 `notes` 包含“自动收盘价更新”的变更记录，显示“今日更新成功”；

  * 若已过 18:00 仍无记录，显示“自动更新失败”。

* 保持与现有 UI 风格一致，不引入新库。

## Render 定时任务

* 新建 Cron Job：

  * Method：`POST`

  * URL：`https://<域名>/api/jobs/stock-close-daily`

  * Header：`X-Job-Token: <JOB_TOKEN>`；在服务环境变量设置 `JOB_TOKEN=<同值>`

  * 时间：每日 18:00 Asia/Shanghai（若 Render 使用 UTC，换算为 `UTC 10:00`）。

## 验证与幂等

* 手动触发：在详情页添加“手动执行收盘更新”按钮或通过 curl 触发作业，观察资产总值与变更记录是否正确。

* 幂等验证：当日重复触发不重复记账；跨日补算支持（如昨日未更新，可按设定是否补算）。

## 后续可选增强

* 行情源适配：支持多源（新浪、腾讯、Yahoo 等），通过 `env` 切换，统一响应结构。

* 精确符号结构：扩展 `AssetHolding` 增加 `symbol` 和 `exchange` 字段。

* 盘中刷新策略：引入退避与并发限流，避免触发频率过高。

如确认该方案，我将开始实现：新增行情查询接口、收盘作业路由、前端实时展示与状态提示，并提供 Render Cron 配置与手动验证入口。
